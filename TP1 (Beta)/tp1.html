<!doctype html>
<html>
    <head>
        <title></title>        
        <style>
            body{ background-color: #808080; }
            canvas{ background-color: rgb(196, 228, 255); }
			textarea{ background-color: black; color: white;}
        </style>
    </head>
    <body>

    	<center>    		            
            <canvas id="my-canvas" width="1000" height="800">
            	Your browser does not support the HTML5 canvas element.
    		</canvas>    		
    	</center>

        <script src="js/gl-matrix.js"></script>
        <script src="modulo-geometria.js"></script>
        <script src="Camera.js"></script>
        <script src="droneCamera.js"></script>
        
        <script id="shader-vs" type="x-shader/x-vertex">

            precision highp float;

            uniform mat4 modelMatrix;            
            uniform mat4 viewMatrix;
            uniform mat4 projMatrix;
            uniform mat4 normalMatrix;

            attribute vec3 aVertexPosition;
            attribute vec3 aVertexNormal;

            varying vec3 vPosWorld; 
            varying vec3 vNormal;    
            
            void main(void) {

                vPosWorld=(modelMatrix*vec4(aVertexPosition,1.0)).xyz; 
                vNormal=(normalMatrix*vec4(aVertexNormal,1.0)).xyz; 
                
                gl_Position = projMatrix * viewMatrix * vec4(vPosWorld, 1.0);              
            }

        </script>

        <!-- Fragment Shader -->

        <script id="shader-fs" type="x-shader/x-fragment">
            
            precision highp float;

            uniform vec4 color;
            
            varying vec3 vPosWorld;
            varying vec3 vNormal;
            
            void main(void) {

                /*
                vec3 lightVec=normalize(vec3(0.0,3.0,5.0)-vPosWorld);
                vec3 diffColor=mix(vec3(0.7,0.7,0.7),vNormal,0.4);
                vec3 color=dot(lightVec,vNormal)*diffColor+vec3(0.2,0.2,0.2);
                */

                gl_FragColor = vec4(color);

            }

        </script>

        <!-- WebGL -->
        
        <script>

            var vec3=glMatrix.vec3; // vector 3D
            var vec4=glMatrix.vec4; // vector 4D
            var mat3=glMatrix.mat3; // matriz 3x3
            var mat4=glMatrix.mat4; // matriz 4x4

            var gl = null;
            var canvas = null;

            var vertexShader = null;
            var fragmentShader = null;

            // --------------

            var modelMatrixUniform = null;
            var viewMatrixUniform = null;
            var projMatrixUniform = null;
            var normalMatrixUniform = null;

            var vertexPositionAttribute = null;
            var vertexNormalAttribute = null;

            var colorUniform = null;

            // --------------

            var trianglesVerticeBuffer = null;
            var trianglesNormalBuffer = null;
            // var trianglesUvBuffer = null;
            var trianglesIndexBuffer = null;

            // ------------

            glProgram = null;

            // ------------
            
            var initialModelMatrix = mat4.create();
            var initialColor = vec4.fromValues(1.0,1.0,1.0,1.0);
            var initialNormalMatrix = mat4.create();

            var viewMatrix = mat4.create();
            var projMatrix = mat4.create();

            // ------------

            var rotate_angle = -1.57078;
            
            var vPosWorld = null;
            var vNormal = null;
            
            // -------------

            // objetos

            var objetos = [];

            // agregar camaras acá

            let camera = null;
            let droneCam = null;
            
            // WebGL Initialization
         
            function initWebGL(){

                canvas = document.getElementById("my-canvas");  

                try{
                    
                    gl = canvas.getContext("webgl");      

                }catch(e){
                    
                    alert("Error: Your browser does not appear to support WebGL.");
                }

                if(gl) {

                    setupWebGL();
                    setupDroneCamera(); // o setupCamera(); para la primera cámara
                    initShaders();
                    crearObjetos();
                    setupVertexShaderMatrix();
                    setupFragmentShaderMatrix();                    
                    start();   

                }else{    
                    alert("Error: Your browser does not appear to support WebGL.");
                }
            }

            function setupWebGL(){
                
                gl.enable(gl.DEPTH_TEST);
                                
                gl.clearColor(0.1, 0.1, 0.2, 1.0);
                gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);     
    
                gl.viewport(0, 0, canvas.width, canvas.height);

            }
                    
            function initShaders() {
                                
                var fs_source = document.getElementById('shader-fs').innerHTML;
                var vs_source = document.getElementById('shader-vs').innerHTML;

                vertexShader = makeShader(vs_source, gl.VERTEX_SHADER);
                fragmentShader = makeShader(fs_source, gl.FRAGMENT_SHADER);
                                
                glProgram = gl.createProgram();
                
                gl.attachShader(glProgram, vertexShader);
                gl.attachShader(glProgram, fragmentShader);
                gl.linkProgram(glProgram);

                if (!gl.getProgramParameter(glProgram, gl.LINK_STATUS)) {
                    alert("Unable to initialize the shader program.");
                }
                
                gl.useProgram(glProgram);
            }
            
            function makeShader(src, type){
                                
                var shader = gl.createShader(type);
                gl.shaderSource(shader, src);
                gl.compileShader(shader);

                if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) {
                    
                    console.log("Error compiling shader: " + gl.getShaderInfoLog(shader));
                }
                
                return shader;
            }
            
            function setupVertexShaderMatrix(){
                
                modelMatrixUniform = gl.getUniformLocation(glProgram, "modelMatrix");
                viewMatrixUniform  = gl.getUniformLocation(glProgram, "viewMatrix");
                projMatrixUniform  = gl.getUniformLocation(glProgram, "projMatrix");
                normalMatrixUniform  = gl.getUniformLocation(glProgram, "normalMatrix");
                
                gl.uniformMatrix4fv(modelMatrixUniform, false, initialModelMatrix);
                gl.uniformMatrix4fv(viewMatrixUniform, false, viewMatrix);
                gl.uniformMatrix4fv(projMatrixUniform, false, projMatrix);
                gl.uniformMatrix4fv(normalMatrixUniform, false, initialNormalMatrix);
            }
            
            function setupFragmentShaderMatrix(){

                colorUniform  = gl.getUniformLocation(glProgram, "color");
                gl.uniform4fv(colorUniform, initialColor);
            }

            function setupCamera() {
                
                camera = new Camera(
			        vec3.fromValues(3, 3, 0), // position
			        vec3.fromValues(0, 0, 0), // lookAt
			        vec3.fromValues(1, 0, 0) // up
		        );

                mat4.perspective(projMatrix, 30.0, canvas.clientWidth / canvas.clientHeight, 0.35, 85.0);
                viewMatrix = camera.updateViewMatrix(viewMatrix);
            }

            function setupDroneCamera() {

                droneCam = new DroneCameraControl([0,0,10]);
                
                mat4.perspective(projMatrix,45, canvas.width / canvas.height, 0.1, 100.0);
                
                mat4.identity(initialModelMatrix);
                mat4.rotate(initialModelMatrix,initialModelMatrix, -1.57078, [1.0, 0.0, 0.0]);

                mat4.identity(viewMatrix);
                mat4.translate(viewMatrix,viewMatrix, [0.0, 0.0, -15.0]);
            }

            //Función auxiliar para los colores
            function vectorRGB (R,G,B) {
                return vec4.fromValues(R/255.0,G/255.0,B/255.0,1.0,1.0);
            }

            function crearObjetos() {

                //una Ayudita
                var ejesAuxiliares = new Ejes();

                // piso
                var piso = new Cuadrado(10,20,100,vectorRGB(255,255,190));
                        objetos.push(piso);

                // Edificio
                var templateEdificio = new Cubo(10,20,10,vectorRGB(150,150,150));
                    templateEdificio.setEscala(1,3,1);
                    templateEdificio.setTraslacion(10,10/2,10);
                        objetos.push(templateEdificio);

                //Base de la Grua
                var base = new Objeto3D();
                var baseGruaRectangulo1 = new Cubo(10,20,2,vectorRGB(255,255,0));
                    baseGruaRectangulo1.setEscala(1,3,1);
                    baseGruaRectangulo1.setTraslacion(0,1,0);
                        base.agregarHijo(baseGruaRectangulo1);
                var baseGruaRectangulo2 = new Cubo(10,20,2,vectorRGB(255,255,0));
                    baseGruaRectangulo2.setEscala(0.75,3,0.75);
                    baseGruaRectangulo2.setTraslacion(0,3,0);
                        base.agregarHijo(baseGruaRectangulo2);
                var baseGruaCilindro = new Cilindro(10,20,0.5,6,vectorRGB(200,200,200));
                    baseGruaCilindro.setTraslacion(0,15,0);
                        base.agregarHijo(baseGruaCilindro);
                        objetos.push(base);
                
                //Cabina
                var cabina = new Objeto3D();
                var habitaculo = new Cubo(10,20,1,vectorRGB(255,255,0));
                    habitaculo.setEscala(2,1,1);
                        cabina.agregarHijo(habitaculo);
                var techo = new Cubo(10,20,0.2,vectorRGB(0,0,0));
                    techo.setTraslacion(0,0.45,0.9);
                    techo.setEscala(10,0.5,4);
                        cabina.agregarHijo(techo);
                var piso = new Cubo(10,20,0.2,vectorRGB(0,0,0));
                    piso.setTraslacion(0,-0.45,1.4);
                    piso.setEscala(10,0.5,9);
                        cabina.agregarHijo(piso);
                var varandaFrontal = new Cubo(10,20,0.2,vectorRGB(100,100,100));
                    varandaFrontal.setTraslacion(0,-0.2,2.2);
                    varandaFrontal.setEscala(10,2,1);
                        cabina.agregarHijo(varandaFrontal);               
                var varandaIzquierda = new Cubo(10,20,0.2,vectorRGB(100,100,100));
                    varandaIzquierda.setTraslacion(0.90,-0.2,1.3);
                    varandaIzquierda.setEscala(1,2,8);
                        cabina.agregarHijo(varandaIzquierda); 
                var varandaDerecha = new Cubo(10,20,0.2,vectorRGB(100,100,100));
                    varandaDerecha.setTraslacion(-0.90,-0.2,1.3);
                    varandaDerecha.setEscala(1,2,8);
                        cabina.agregarHijo(varandaDerecha);  
                var soportePoleaIzquierda = new Cubo(10,20,0.2,vectorRGB(100,60,30));
                    soportePoleaIzquierda.setTraslacion(0.3,1,0);
                    soportePoleaIzquierda.setEscala(1,5,2);
                        cabina.agregarHijo(soportePoleaIzquierda);        
                var soportePoleaDerecha = new Cubo(10,20,0.2,vectorRGB(100,60,30));
                    soportePoleaDerecha.setTraslacion(-0.3,1,0);
                    soportePoleaDerecha.setEscala(1,5,2);
                        cabina.agregarHijo(soportePoleaDerecha);   
                var poleaIzquierda = new Circulo(10,20,0.2,vectorRGB(180,180,180));
                    poleaIzquierda.setTraslacion(0.41,1.2,0);
                    poleaIzquierda.setRotacion(0,0,3.14/2);
                        cabina.agregarHijo(poleaIzquierda);        
                var poleaDerecha = new Circulo(10,20,0.2,vectorRGB(180,180,180));
                    poleaDerecha.setTraslacion(-0.41,1.2,0);
                    poleaDerecha.setRotacion(0,0,3.14/2);
                        cabina.agregarHijo(poleaDerecha);                       
                //Una vez armada la cabina la colocamos en la escena                
                cabina.setTraslacion(0,19,-2);    
                cabina.setEscala(2,2,2);
                            objetos.push(cabina); 

                //Brazo
                var brazo = new Objeto3D();
                    brazo.setTraslacion(0,21,0);
                var viga = new Cubo(10,20,0.8,vectorRGB(255,255,0));
                    viga.setTraslacion(0,0.5,5);
                    viga.setEscala(1,1,30);
                    brazo.agregarHijo(viga);
                var contrapeso = new Cubo(10,20,2,vectorRGB(150,150,150));
                    contrapeso.setTraslacion(0,0.5,-8);
                    contrapeso.setEscala(2,1,1);
                    brazo.agregarHijo(contrapeso);
                var poleaIzquierdaViga = new Circulo(10,20,0.2,vectorRGB(180,180,180));
                    poleaIzquierdaViga.setTraslacion(0.41,0.5,16.5);
                    poleaIzquierdaViga.setRotacion(0,0,3.14/2);
                        brazo.agregarHijo(poleaIzquierdaViga);        
                 var poleaDerechaViga = new Circulo(10,20,0.2,vectorRGB(180,180,180));
                    poleaDerechaViga.setTraslacion(-0.41,0.5,16.5);
                    poleaDerechaViga.setRotacion(0,0,3.14/2);
                        brazo.agregarHijo(poleaDerechaViga); 
                        var poleaDerechaViga = new Circulo(10,20,0.2,vectorRGB(180,180,180));
                    objetos.push(brazo);

                //Soga y Plataforma
                var sogaYPlataforma = new Objeto3D();
                    sogaYPlataforma.setTraslacion(0,16.5,16.5);


                var soga = new Cubo(10,20,0.1,vectorRGB(200,190,150));
                    soga.setTraslacion(0,2.5,0);
                    soga.setEscala(1,50,1);
                    sogaYPlataforma.agregarHijo(soga);
                var soga1 = new Cubo(10,20,0.1,vectorRGB(200,190,150));
                    soga1.setRotacion(3.14/4,0,3.14/4);
                    soga1.setTraslacion(0,-2.5,0);
                    soga1.setEscala(1,50,1);
                    sogaYPlataforma.agregarHijo(soga1);
                var soga2 = new Cubo(10,20,0.1,vectorRGB(200,190,150));
                    soga2.setRotacion(-3.14/4,0,3.14/4);
                    soga2.setTraslacion(0,-2.5,0);
                    soga2.setEscala(1,50,1);
                    sogaYPlataforma.agregarHijo(soga2);
                    var soga3 = new Cubo(10,20,0.1,vectorRGB(200,190,150));
                    soga3.setRotacion(3.14/4,0,-3.14/4);
                    soga3.setTraslacion(0,-2.5,0);
                    soga3.setEscala(1,50,1);
                    sogaYPlataforma.agregarHijo(soga3);
                var soga4 = new Cubo(10,20,0.1,vectorRGB(200,190,150));
                    soga4.setRotacion(-3.14/4,0,-3.14/4);
                    soga4.setTraslacion(0,-2.5,0);
                    soga4.setEscala(1,50,1);
                    sogaYPlataforma.agregarHijo(soga4);
                var plataforma = new Cubo(10,20,1,vectorRGB(100,60,30));
                    plataforma.setTraslacion(0,-2.5,0);
                    plataforma.setEscala(7.5,0.2,5.5);
                    sogaYPlataforma.agregarHijo(plataforma);
                        objetos.push(sogaYPlataforma);

                //La grua en una pieza
                var grua = new Objeto3D();
                grua.agregarHijo(base);
                grua.agregarHijo(cabina);
                grua.agregarHijo(brazo);
                grua.agregarHijo(sogaYPlataforma);
                grua.setEscala(1,1,1);
                objetos.push(grua);
                

            }

            function drawScene(){

                setupVertexShaderMatrix();

                for (let index = 0; index < objetos.length; index++) 
                    objetos[index].dibujar(mat4.create());                

            }
            
            function start(){                
                viewMatrix=droneCam.getViewMatrix();

                requestAnimationFrame(start);

                droneCam.update();
                drawScene();
            }
            
            window.onload=initWebGL;

        </script>
    </body>
</html>
